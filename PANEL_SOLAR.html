<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Solar Puno</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #FDB813, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
        }
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            color: #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        #canvas {
            width: 100%;
            height: 500px;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #FFDAB9 100%);
            border-radius: 15px;
            border: 3px solid #1e3c72;
            cursor: grab;
            display: block;
        }
        #canvas:active { cursor: grabbing; }
        .stat-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 10px;
        }
        .stat-box .value { font-size: 2em; font-weight: bold; }
        .stat-box .label { font-size: 0.9em; opacity: 0.9; }
        .slider-group {
            margin-bottom: 15px;
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
        }
        .slider-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #1e3c72;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #667eea, #764ba2);
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1e3c72;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .value-display {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            margin-top: 5px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 0.95em;
        }
        button:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .btn-info { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
        .info-text {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
            font-size: 0.9em;
        }
        .chart { height: 300px; margin: 15px 0; }
        @media (max-width: 1200px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚òÄÔ∏è Simulador Solar Puno</h1>
            <p style="font-size: 1.2em; margin-top: 10px;">üìç Puno, Per√∫ | üåç -15.84¬∞, -70.02¬∞ | ‚õ∞Ô∏è 3,827 msnm</p>
        </div>

        <div class="grid">
            <!-- Panel Izquierdo: Estad√≠sticas -->
            <div>
                <div class="stat-box">
                    <div class="label">POA Actual</div>
                    <div class="value" id="poaValue">--</div>
                    <div class="label">W/m¬≤</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                    <div class="label">Energ√≠a Diaria</div>
                    <div class="value" id="dailyValue">--</div>
                    <div class="label">kWh/m¬≤</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    <div class="label">Energ√≠a Anual</div>
                    <div class="value" id="annualValue">--</div>
                    <div class="label">kWh/m¬≤</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                    <div class="label">Factor Coseno</div>
                    <div class="value" id="cosineValue">--</div>
                    <div class="label">cos(Œ∏)</div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h2>üìç Datos de Puno</h2>
                    <div class="info-text">
                        <strong>Altitud:</strong> 3,827 m<br>
                        <strong>GHI Promedio:</strong> 6.2 kWh/m¬≤/d√≠a<br>
                        <strong>D√≠as despejados:</strong> ~280/a√±o<br>
                        <strong>Temp. media:</strong> 8-10¬∞C
                    </div>
                </div>
            </div>

            <!-- Panel Central: Visualizaci√≥n -->
            <div class="card">
                <h2>üéØ Visualizaci√≥n Interactiva</h2>
                <canvas id="canvas"></canvas>
                <div class="info-text">
                    <strong>üí° Controles:</strong> Arrastra el <strong>panel</strong> o el <strong>sol</strong> ‚Ä¢ 
                    Usa <strong>flechas ‚Üë‚Üì‚Üê‚Üí</strong> ‚Ä¢ <strong>Espacio</strong>: animar ‚Ä¢ 
                    <strong>Doble clic</strong>: reset
                </div>
                <div class="chart" id="dailyChart"></div>
            </div>

            <!-- Panel Derecho: Controles -->
            <div class="card">
                <h2>üéÆ Controles</h2>
                
                <div class="slider-group">
                    <label>üìÖ D√≠a del A√±o: <span id="dayText">172</span></label>
                    <input type="range" id="daySlider" min="1" max="365" value="172">
                    <div class="value-display" id="monthText">Jun</div>
                </div>

                <div class="slider-group">
                    <label>üïê Hora: <span id="hourText">12:00</span></label>
                    <input type="range" id="hourSlider" min="6" max="18" value="12" step="0.25">
                </div>

                <div class="slider-group">
                    <label>üîß Inclinaci√≥n (Œ≤): <span id="tiltText">15¬∞</span></label>
                    <input type="range" id="tiltSlider" min="0" max="90" value="15">
                </div>

                <div class="slider-group">
                    <label>üß≠ Azimuth (Œ≥): <span id="azimuthText">0¬∞</span></label>
                    <input type="range" id="azimuthSlider" min="0" max="360" value="0" step="5">
                </div>

                <div class="slider-group">
                    <label>‚òÄÔ∏è GHI: <span id="ghiText">240 W/m¬≤</span></label>
                    <input type="range" id="ghiSlider" min="100" max="350" value="240" step="5">
                </div>

                <button class="btn-primary" onclick="animateDay()" id="animBtn">‚ñ∂Ô∏è Animar D√≠a</button>
                <button class="btn-success" onclick="optimize()">üéØ Optimizar Tilt</button>
                <button class="btn-info" onclick="reset()">üîÑ Reiniciar</button>
                <button class="btn-warning" onclick="showHelp()">‚ùì Ayuda</button>

                <div class="chart" id="annualChart"></div>
            </div>
        </div>
    </div>

    <script>
        const LAT = -15.84;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let animationId = null;
        let isDragging = false;
        let dragType = null;
        let clouds = [];
        let particles = [];

        // Inicializar nubes
        for (let i = 0; i < 5; i++) {
            clouds.push({
                x: Math.random() * 100,
                y: 20 + Math.random() * 30,
                speed: 0.05 + Math.random() * 0.1,
                size: 20 + Math.random() * 30
            });
        }

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            draw();
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Funciones f√≠sicas
        function solarDeclination(day) {
            return 23.45 * Math.sin(2 * Math.PI * (day - 81) / 365);
        }

        function hourAngle(hour) {
            return 15 * (hour - 12);
        }

        function zenithAngle(lat, dec, ha) {
            const latR = lat * Math.PI / 180;
            const decR = dec * Math.PI / 180;
            const haR = ha * Math.PI / 180;
            const cosZ = Math.sin(latR) * Math.sin(decR) + Math.cos(latR) * Math.cos(decR) * Math.cos(haR);
            return Math.acos(Math.max(-1, Math.min(1, cosZ))) * 180 / Math.PI;
        }

        function solarAzimuth(lat, dec, ha, zenith) {
            const latR = lat * Math.PI / 180;
            const decR = dec * Math.PI / 180;
            const zenR = zenith * Math.PI / 180;
            const cosAz = (Math.sin(decR) - Math.sin(latR) * Math.cos(zenR)) / (Math.cos(latR) * Math.sin(zenR));
            let az = Math.acos(Math.max(-1, Math.min(1, cosAz))) * 180 / Math.PI;
            return ha > 0 ? 360 - az : az;
        }

        function angleOfIncidence(zenith, solarAz, tilt, panelAz) {
            const zenR = zenith * Math.PI / 180;
            const tiltR = tilt * Math.PI / 180;
            const azDiff = (solarAz - panelAz) * Math.PI / 180;
            const cosAOI = Math.cos(zenR) * Math.cos(tiltR) + Math.sin(zenR) * Math.sin(tiltR) * Math.cos(azDiff);
            return Math.acos(Math.max(0, Math.min(1, cosAOI))) * 180 / Math.PI;
        }

        function calculatePOA(ghi, zenith, aoi, tilt) {
            if (zenith > 90) return 0;
            const zenR = zenith * Math.PI / 180;
            const aoiR = aoi * Math.PI / 180;
            const tiltR = tilt * Math.PI / 180;
            const cosZenith = Math.cos(zenR);
            const cosAOI = Math.cos(aoiR);
            const directFactor = cosAOI / Math.max(0.01, cosZenith);
            const diffuseFactor = (1 + Math.cos(tiltR)) / 2;
            const poa = ghi * (0.7 * directFactor + 0.3 * diffuseFactor);
            return Math.max(0, Math.min(poa, ghi * 2));
        }

        function drawArrow(x1, y1, x2, y2, color, width) {
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = width;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            const angle = Math.atan2(y2 - y1, x2 - x1);
            const headlen = 10;
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();
        }

        function draw() {
            const day = parseInt(document.getElementById('daySlider').value);
            const hour = parseFloat(document.getElementById('hourSlider').value);
            const tilt = parseInt(document.getElementById('tiltSlider').value);
            const azimuth = parseInt(document.getElementById('azimuthSlider').value);
            const ghi = parseInt(document.getElementById('ghiSlider').value);

            // Actualizar displays
            document.getElementById('dayText').textContent = day;
            document.getElementById('tiltText').textContent = tilt + '¬∞';
            document.getElementById('azimuthText').textContent = azimuth + '¬∞';
            document.getElementById('ghiText').textContent = ghi + ' W/m¬≤';
            const hours = Math.floor(hour);
            const mins = Math.round((hour - hours) * 60);
            document.getElementById('hourText').textContent = `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}`;
            
            const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            const monthIndex = Math.floor((day - 1) / 30.5);
            document.getElementById('monthText').textContent = months[monthIndex];

            // C√°lculos
            const dec = solarDeclination(day);
            const ha = hourAngle(hour);
            const zenith = zenithAngle(LAT, dec, ha);
            const solarAz = solarAzimuth(LAT, dec, ha, zenith);
            const aoi = angleOfIncidence(zenith, solarAz, tilt, azimuth);
            const poa = calculatePOA(ghi, zenith, aoi, tilt);
            const cosineFactor = Math.cos(aoi * Math.PI / 180);
            const dailyEnergy = (poa * 24 / 1000).toFixed(2);

            document.getElementById('poaValue').textContent = poa.toFixed(0);
            document.getElementById('dailyValue').textContent = dailyEnergy;
            document.getElementById('cosineValue').textContent = cosineFactor.toFixed(3);

            // Calcular energ√≠a anual
            let annualEnergy = 0;
            for (let d = 1; d <= 365; d += 5) {
                const decA = solarDeclination(d);
                const zenA = zenithAngle(LAT, decA, 0);
                const solarAzA = solarAzimuth(LAT, decA, 0, zenA);
                const aoiA = angleOfIncidence(zenA, solarAzA, tilt, azimuth);
                const poaA = calculatePOA(240, zenA, aoiA, tilt);
                annualEnergy += poaA * 24 / 1000;
            }
            document.getElementById('annualValue').textContent = annualEnergy.toFixed(0);

            // Dibujar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const w = canvas.width;
            const h = canvas.height;
            const centerX = w / 2;
            const groundY = h * 0.75;

            // Cielo con gradiente seg√∫n hora
            const skyGrad = ctx.createLinearGradient(0, 0, 0, groundY);
            if (hour < 8) {
                skyGrad.addColorStop(0, '#1e3a5f');
                skyGrad.addColorStop(1, '#5b7c99');
            } else if (hour > 17) {
                skyGrad.addColorStop(0, '#ff6b35');
                skyGrad.addColorStop(1, '#ffa07a');
            } else {
                skyGrad.addColorStop(0, '#87CEEB');
                skyGrad.addColorStop(1, '#E0F6FF');
            }
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, w, groundY);

            // Nubes
            clouds.forEach(cloud => {
                cloud.x += cloud.speed;
                if (cloud.x > 110) cloud.x = -10;
                const cx = (cloud.x / 100) * w;
                const cy = (cloud.y / 100) * groundY;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.beginPath();
                ctx.arc(cx, cy, cloud.size, 0, Math.PI * 2);
                ctx.arc(cx + cloud.size * 0.6, cy, cloud.size * 0.8, 0, Math.PI * 2);
                ctx.fill();
            });

            // Suelo
            ctx.fillStyle = '#8B7355';
            ctx.fillRect(0, groundY, w, h - groundY);

            // Panel solar
            const panelLen = 200;
            const tiltR = tilt * Math.PI / 180;
            const px1 = centerX - panelLen / 2 * Math.cos(tiltR);
            const py1 = groundY + panelLen / 2 * Math.sin(tiltR);
            const px2 = centerX + panelLen / 2 * Math.cos(tiltR);
            const py2 = groundY - panelLen / 2 * Math.sin(tiltR);

            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath();
            ctx.ellipse(centerX, groundY + 10, panelLen / 2, 15, 0, 0, Math.PI * 2);
            ctx.fill();

            // Panel
            ctx.strokeStyle = '#1e3c72';
            ctx.lineWidth = 12;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(px1, py1);
            ctx.lineTo(px2, py2);
            ctx.stroke();

            ctx.strokeStyle = '#4ECDC4';
            ctx.lineWidth = 8;
            ctx.stroke();

            // Celdas
            for (let i = 0; i < 6; i++) {
                const t = i / 5;
                const x = px1 + (px2 - px1) * t;
                const y = py1 + (py2 - py1) * t;
                ctx.strokeStyle = '#2a5298';
                ctx.lineWidth = 2;
                ctx.beginPath();
                const normalA = tiltR + Math.PI / 2;
                ctx.moveTo(x - 15 * Math.cos(normalA), y - 15 * Math.sin(normalA));
                ctx.lineTo(x + 15 * Math.cos(normalA), y + 15 * Math.sin(normalA));
                ctx.stroke();
            }

            // Vector normal
            const normalLen = 80;
            const normalAngle = tiltR + Math.PI / 2;
            const nx = centerX + normalLen * Math.cos(normalAngle);
            const ny = groundY - normalLen * Math.sin(normalAngle);
            drawArrow(centerX, groundY, nx, ny, '#FF6B35', 4);

            // Sol
            if (zenith < 90) {
                const sunAngle = (90 - zenith) * Math.PI / 180;
                const sunX = centerX - 250 * Math.cos(sunAngle);
                const sunY = groundY - 250 * Math.sin(sunAngle);

                // Halo
                const haloGrad = ctx.createRadialGradient(sunX, sunY, 0, sunX, sunY, 50);
                haloGrad.addColorStop(0, 'rgba(253, 184, 19, 0.8)');
                haloGrad.addColorStop(1, 'rgba(253, 184, 19, 0)');
                ctx.fillStyle = haloGrad;
                ctx.beginPath();
                ctx.arc(sunX, sunY, 50, 0, Math.PI * 2);
                ctx.fill();

                // N√∫cleo
                ctx.fillStyle = '#FDB813';
                ctx.beginPath();
                ctx.arc(sunX, sunY, 25, 0, Math.PI * 2);
                ctx.fill();

                // Rayos
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    ctx.strokeStyle = 'rgba(253, 184, 19, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(sunX + 28 * Math.cos(angle), sunY + 28 * Math.sin(angle));
                    ctx.lineTo(sunX + 45 * Math.cos(angle), sunY + 45 * Math.sin(angle));
                    ctx.stroke();
                }

                // Rayos al panel
                for (let i = 0; i < 5; i++) {
                    const sx = sunX + (i - 2) * 20;
                    const ex = centerX + (i - 2) * 25;
                    drawArrow(sx, sunY + 30, ex, groundY, '#FDB813', 2);
                }

                // Part√≠culas
                if (poa > 300 && Math.random() > 0.8) {
                    particles.push({ x: sunX, y: sunY + 30, life: 1 });
                }
                particles = particles.filter(p => {
                    p.life -= 0.02;
                    const progress = 1 - p.life;
                    const x = p.x + (centerX - p.x) * progress;
                    const y = p.y + (groundY - p.y) * progress;
                    ctx.fillStyle = `rgba(253, 184, 19, ${p.life})`;
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                    return p.life > 0;
                });

                // Vector efectivo
                const effLen = 70 * Math.max(0, cosineFactor);
                if (effLen > 5) {
                    const ex = centerX + effLen * Math.cos(normalAngle);
                    const ey = groundY - effLen * Math.sin(normalAngle);
                    drawArrow(centerX, groundY, ex, ey, '#95E1D3', 5);
                }
            }

            // Info panel
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.fillRect(10, 10, 180, 120);
            ctx.strokeStyle = '#1e3c72';
            ctx.lineWidth = 2;
            ctx.strokeRect(10, 10, 180, 120);
            
            ctx.fillStyle = '#1e3c72';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('üìä Datos', 20, 30);
            ctx.font = '12px Arial';
            ctx.fillText(`Zenith: ${zenith.toFixed(1)}¬∞`, 20, 50);
            ctx.fillText(`AOI: ${aoi.toFixed(1)}¬∞`, 20, 68);
            ctx.fillText(`Azimuth: ${solarAz.toFixed(0)}¬∞`, 20, 86);
            ctx.fillText(`POA: ${poa.toFixed(0)} W/m¬≤`, 20, 104);
            ctx.fillText(`Factor: ${(cosineFactor * 100).toFixed(0)}%`, 20, 122);

            updateCharts();
        }

        function updateCharts() {
            const day = parseInt(document.getElementById('daySlider').value);
            const tilt = parseInt(document.getElementById('tiltSlider').value);

            // Perfil diario
            const hours = [];
            const poas = [];
            for (let h = 6; h <= 18; h += 0.5) {
                hours.push(h);
                const dec = solarDeclination(day);
                const ha = hourAngle(h);
                const zen = zenithAngle(LAT, dec, ha);
                const solarAz = solarAzimuth(LAT, dec, ha, zen);
                const aoi = angleOfIncidence(zen, solarAz, tilt, 0);
                const ghiCalc = zen < 90 ? 240 * Math.cos(zen * Math.PI / 180) : 0;
                const poa = calculatePOA(ghiCalc, zen, aoi, tilt);
                poas.push(poa);
            }

            Plotly.newPlot('dailyChart', [{
                x: hours,
                y: poas,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#FDB813', width: 3 },
                fill: 'tozeroy',
                fillcolor: 'rgba(253, 184, 19, 0.3)'
            }], {
                title: 'Perfil Diario POA',
                xaxis: { title: 'Hora' },
                yaxis: { title: 'POA (W/m¬≤)' },
                margin: { t: 40, l: 50, r: 20, b: 40 }
            }, { responsive: true, displayModeBar: false });

            // Energ√≠a anual vs tilt
            const tilts = [];
            const energies = [];
            for (let t = 0; t <= 90; t += 5) {
                tilts.push(t);
                let e = 0;
                for (let d = 1; d <= 365; d += 5) {
                    const dec = solarDeclination(d);
                    const zen = zenithAngle(LAT, dec, 0);
                    const solarAz = solarAzimuth(LAT, dec, 0, zen);
                    const aoi = angleOfIncidence(zen, solarAz, t, 0);
                    const poa = calculatePOA(240, zen, aoi, t);
                    e += poa * 24 / 1000;
                }
                energies.push(e);
            }

            Plotly.newPlot('annualChart', [{
                x: tilts,
                y: energies,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#667eea', width: 3 },
                fill: 'tozeroy',
                fillcolor: 'rgba(102, 126, 234, 0.2)'
            }], {
                title: 'Energ√≠a Anual vs Tilt',
                xaxis: { title: 'Inclinaci√≥n (¬∞)' },
                yaxis: { title: 'Energ√≠a (kWh/m¬≤/a√±o)' },
                margin: { t: 40, l: 50, r: 20, b: 40 }
            }, { responsive: true, displayModeBar: false });
        }

        // Interactividad
        let mousePos = { x: 0, y: 0 };

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mousePos.x = e.clientX - rect.left;
            mousePos.y = e.clientY - rect.top;

            if (isDragging && dragType === 'panel') {
                const w = canvas.width;
                const h = canvas.height;
                const centerX = w / 2;
                const groundY = h * 0.75;
                const dx = mousePos.x - centerX;
                const dy = groundY - mousePos.y;
                let newTilt = Math.atan2(dy, dx) * 180 / Math.PI;
                newTilt = Math.max(0, Math.min(90, newTilt));
                document.getElementById('tiltSlider').value = Math.round(newTilt);
                draw();
            } else if (isDragging && dragType === 'sun') {
                const w = canvas.width;
                const h = canvas.height;
                const centerX = w / 2;
                const groundY = h * 0.75;
                const dx = centerX - mousePos.x;
                const dy = groundY - mousePos.y;
                let angle = Math.atan2(dy, dx);
                let newHour = 12 + (angle - Math.PI / 2) * 2;
                newHour = Math.max(6, Math.min(18, newHour));
                document.getElementById('hourSlider').value = newHour.toFixed(2);
                draw();
            }
        });

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            const w = canvas.width;
            const h = canvas.height;
            const centerX = w / 2;
            const groundY = h * 0.75;

            // Detectar clic en panel
            const tilt = parseInt(document.getElementById('tiltSlider').value);
            const tiltR = tilt * Math.PI / 180;
            const panelLen = 200;
            const px1 = centerX - panelLen / 2 * Math.cos(tiltR);
            const py1 = groundY + panelLen / 2 * Math.sin(tiltR);
            const px2 = centerX + panelLen / 2 * Math.cos(tiltR);
            const py2 = groundY - panelLen / 2 * Math.sin(tiltR);

            const distToPanel = pointToLineDistance(clickX, clickY, px1, py1, px2, py2);
            if (distToPanel < 25) {
                isDragging = true;
                dragType = 'panel';
                return;
            }

            // Detectar clic en sol
            const day = parseInt(document.getElementById('daySlider').value);
            const hour = parseFloat(document.getElementById('hourSlider').value);
            const dec = solarDeclination(day);
            const ha = hourAngle(hour);
            const zenith = zenithAngle(LAT, dec, ha);

            if (zenith < 90) {
                const sunAngle = (90 - zenith) * Math.PI / 180;
                const sunX = centerX - 250 * Math.cos(sunAngle);
                const sunY = groundY - 250 * Math.sin(sunAngle);
                const distToSun = Math.sqrt((clickX - sunX) ** 2 + (clickY - sunY) ** 2);
                
                if (distToSun < 35) {
                    isDragging = true;
                    dragType = 'sun';
                }
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
            dragType = null;
        });

        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
            dragType = null;
        });

        canvas.addEventListener('dblclick', reset);

        function pointToLineDistance(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            if (lenSq !== 0) param = dot / lenSq;
            let xx, yy;
            if (param < 0) {
                xx = x1; yy = y1;
            } else if (param > 1) {
                xx = x2; yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            const dx = px - xx;
            const dy = py - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Controles
        function animateDay() {
            const btn = document.getElementById('animBtn');
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
                btn.innerHTML = '‚ñ∂Ô∏è Animar D√≠a';
                return;
            }
            btn.innerHTML = '‚è∏Ô∏è Pausar';
            let h = 6;
            function frame() {
                h += 0.05;
                if (h > 18) h = 6;
                document.getElementById('hourSlider').value = h;
                draw();
                animationId = requestAnimationFrame(frame);
            }
            frame();
        }

        function optimize() {
            const day = parseInt(document.getElementById('daySlider').value);
            let maxPOA = 0;
            let bestTilt = 0;
            for (let t = 0; t <= 90; t++) {
                const dec = solarDeclination(day);
                const zen = zenithAngle(LAT, dec, 0);
                const solarAz = solarAzimuth(LAT, dec, 0, zen);
                const aoi = angleOfIncidence(zen, solarAz, t, 0);
                const poa = calculatePOA(240, zen, aoi, t);
                if (poa > maxPOA) {
                    maxPOA = poa;
                    bestTilt = t;
                }
            }
            document.getElementById('tiltSlider').value = bestTilt;
            draw();
            alert(`‚úÖ Inclinaci√≥n √≥ptima: ${bestTilt}¬∞ | POA m√°ximo: ${maxPOA.toFixed(1)} W/m¬≤`);
        }

        function reset() {
            document.getElementById('daySlider').value = 172;
            document.getElementById('hourSlider').value = 12;
            document.getElementById('tiltSlider').value = 15;
            document.getElementById('azimuthSlider').value = 0;
            document.getElementById('ghiSlider').value = 240;
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
                document.getElementById('animBtn').innerHTML = '‚ñ∂Ô∏è Animar D√≠a';
            }
            draw();
        }

        function showHelp() {
            alert(`üéØ GU√çA DE USO DEL SIMULADOR SOLAR

üñ±Ô∏è CONTROLES CON MOUSE:
‚Ä¢ Arrastra el PANEL SOLAR para cambiar su inclinaci√≥n
‚Ä¢ Arrastra el SOL para modificar la hora del d√≠a
‚Ä¢ Doble clic en el canvas para reiniciar valores

‚å®Ô∏è ATAJOS DE TECLADO:
‚Ä¢ ‚Üë / ‚Üì : Ajustar inclinaci√≥n
‚Ä¢ ‚Üê / ‚Üí : Avanzar/retroceder tiempo
‚Ä¢ Espacio: Iniciar/pausar animaci√≥n
‚Ä¢ R: Reset

üìä INDICADORES:
‚Ä¢ POA: Irradiancia sobre el plano inclinado
‚Ä¢ Factor Coseno: Eficiencia geom√©trica (0-1)
‚Ä¢ AOI: √Ångulo de incidencia
‚Ä¢ Energ√≠a Anual: Producci√≥n total kWh/m¬≤/a√±o

üí° TIPS PARA PUNO:
‚úì Mejor tilt: 10-20¬∞ (cercano a latitud)
‚úì Azimuth √≥ptimo: 0¬∞ (norte)
‚úì Alta radiaci√≥n por altitud
‚úì Temperaturas bajas mejoran eficiencia`);
        }

        // Event listeners
        document.getElementById('daySlider').addEventListener('input', draw);
        document.getElementById('hourSlider').addEventListener('input', draw);
        document.getElementById('tiltSlider').addEventListener('input', draw);
        document.getElementById('azimuthSlider').addEventListener('input', draw);
        document.getElementById('ghiSlider').addEventListener('input', draw);

        // Teclado
        document.addEventListener('keydown', (e) => {
            const tiltSlider = document.getElementById('tiltSlider');
            const hourSlider = document.getElementById('hourSlider');
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    tiltSlider.value = Math.min(90, parseInt(tiltSlider.value) + 1);
                    draw();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    tiltSlider.value = Math.max(0, parseInt(tiltSlider.value) - 1);
                    draw();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    hourSlider.value = Math.min(18, parseFloat(hourSlider.value) + 0.25);
                    draw();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    hourSlider.value = Math.max(6, parseFloat(hourSlider.value) - 0.25);
                    draw();
                    break;
                case ' ':
                    e.preventDefault();
                    animateDay();
                    break;
                case 'r':
                case 'R':
                    e.preventDefault();
                    reset();
                    break;
                case 'o':
                case 'O':
                    e.preventDefault();
                    optimize();
                    break;
            }
        });

        // Animaci√≥n continua para efectos
        function animate() {
            draw();
            requestAnimationFrame(animate);
        }
        animate();

        // Log de bienvenida
        console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     ‚òÄÔ∏è SIMULADOR SOLAR FOTOVOLTAICO - PUNO, PER√ö ‚òÄÔ∏è      ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  üìç Ubicaci√≥n: Puno (-15.84¬∞, -70.02¬∞)                   ‚ïë
‚ïë  ‚õ∞Ô∏è  Altitud: 3,827 msnm                                  ‚ïë
‚ïë  ‚òÄÔ∏è GHI Promedio: 6.2 kWh/m¬≤/d√≠a                         ‚ïë
‚ïë  üå°Ô∏è Temperatura: 8-10¬∞C                                   ‚ïë
‚ïë                                                           ‚ïë
‚ïë  üéÆ CONTROLES:                                            ‚ïë
‚ïë  ‚Ä¢ Arrastra el panel o el sol con el mouse               ‚ïë
‚ïë  ‚Ä¢ Usa las flechas del teclado                           ‚ïë
‚ïë  ‚Ä¢ Presiona ESPACIO para animar                          ‚ïë
‚ïë  ‚Ä¢ Doble clic para reiniciar                             ‚ïë
‚ïë                                                           ‚ïë
‚ïë  üöÄ ¬°Explora c√≥mo la geometr√≠a solar afecta la energ√≠a!  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`);
    </script>
</body>
</html>
